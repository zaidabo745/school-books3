<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برنامج توزيع الكتب المدرسية</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #0056b3; --secondary-color: #f8f9fa; --border-color: #dee2e6;
            --text-color: #333; --header-color: #004085; --success-color: #28a745;
            --danger-color: #dc3545; --font-family: 'Tajawal', 'Almarai', sans-serif;
            --school-bg: #fff; --class-bg: #fdfdfd; --subject-bg: #f9f9f9;
        }
        body { font-family: var(--font-family); background-color: var(--secondary-color); color: var(--text-color); margin: 0; padding: 10px; }
        .container { max-width: 1200px; margin: 0 auto; background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid var(--border-color); padding-bottom: 20px; }
        header h1 { font-size: 2.2em; color: var(--header-color); margin: 0; }
        header p { font-size: 1em; color: #6c757d; margin-top: 5px; }

        .tabs { display: flex; justify-content: center; margin-bottom: 25px; border-bottom: 1px solid var(--border-color); }
        .tab-button { padding: 12px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 1.1em; font-family: var(--font-family); margin: 0 5px; border-bottom: 3px solid transparent; }
        .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .school-container { background-color: var(--school-bg); border: 2px solid #b8daff; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        
        .school-header, .class-header { display: block; margin-bottom: 15px; }
        .name-container { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        /* Style change for responsive input */
        .name-container input, .name-container select { flex-grow: 1; min-width: 0; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 1.2em; font-weight: bold; }
        
        .remove-btn {
            background: var(--danger-color); color: white; border: none;
            width: 38px; height: 38px; border-radius: 50%;
            cursor: pointer; font-weight: bold; font-size: 20px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; line-height: 1;
        }
        .class-container { background-color: var(--class-bg); border: 1px solid #cfe2ff; border-radius: 6px; padding: 15px; margin-top: 15px; }
        .subject-entry { display: flex; flex-wrap: wrap; gap: 15px; padding: 15px; padding-top: 25px; border: 1px dashed #ced4da; border-radius: 8px; margin-top: 10px; align-items: flex-end; position: relative; background: var(--subject-bg); }
        .subject-entry .remove-btn { width: 30px; height: 30px; font-size: 16px; position: absolute; top: 10px; left: 10px; }
        
        .input-group { display: flex; flex-direction: column; flex-grow: 1; min-width: 130px; }
        .input-group label { margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        .input-group input { padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 1em; width: 100%; box-sizing: border-box; }
        
        .result-area { flex-basis: 100%; margin-top: 15px; padding: 15px; background-color: #eef7ff; border: 1px dashed var(--primary-color); border-radius: 5px; font-weight: bold; min-height: 60px; text-align: center; }
        
        .btn-add-level { background-color: var(--primary-color); color: white; padding: 10px; font-size: 1em; border-radius: 5px; border: none; cursor: pointer; width: 100%; }
        
        .top-action-buttons { display: flex; gap: 15px; margin-bottom: 20px; }
        .top-action-buttons button { flex-grow: 1; padding: 12px; font-size: 1.1em; border-radius: 5px; border: none; cursor: pointer; }
        
        .main-action-buttons { display: flex; flex-direction: column; gap: 15px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .main-action-buttons button { padding: 12px 30px; font-size: 1.1em; border-radius: 5px; border: none; cursor: pointer; width: 100%; }
        .btn-add-school { background-color: var(--header-color); color: white; }
        .btn-add-class { background-color: #007bff; color: white; }
        .btn-calculate { background-color: var(--success-color); color: white; }
        .btn-export { background-color: #1d6f42; color: white; }

        /* New Status Message Style */
        #status-message {
            padding: 12px; margin: 20px 0; border-radius: 5px;
            text-align: center; font-weight: bold; display: none;
        }
        #status-message.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        #status-message.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>برنامج توزيع الكتب المدرسية</h1>
            <p>تم الإنشاء والتطوير بواسطة حارث الغنبوصي</p>
        </header>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('inputs-tab', this)">المدخلات</button>
            <button class="tab-button" onclick="showTab('log-tab', this)">السجل</button>
        </div>

        <div id="inputs-tab" class="tab-content active">
            <!-- Button layout changed as requested -->
            <div class="top-action-buttons">
                <button class="btn-add-school" onclick="addSchool()">+ إضافة مدرسة جديدة</button>
                <button class="btn-add-class" onclick="addClassToLastSchool()">+ إضافة صف للمدرسة الأخيرة</button>
            </div>
            <div id="schools-container"></div>
        </div>

        <div id="log-tab" class="tab-content">
            <p>لا توجد عمليات مسجلة بعد.</p>
        </div>
        
        <!-- Moved status message here -->
        <div id="status-message"></div>

        <div class="main-action-buttons">
            <button class="btn-calculate" onclick="calculateAll()">احسب الجميع</button>
            <button class="btn-export" onclick="exportToExcel()">تصدير إلى Excel</button>
        </div>
    </div>

<script>
let calculationLog = [];

document.addEventListener('DOMContentLoaded', () => addSchool());

function showTab(tabId, element) { /* ... same as before ... */ }

function addSchool() {
    const container = document.getElementById('schools-container');
    const schoolId = 'school-' + Date.now();
    const schoolDiv = document.createElement('div');
    schoolDiv.className = 'school-container';
    schoolDiv.id = schoolId;
    schoolDiv.innerHTML = `
        <div class="school-header">
            <div class="name-container">
                <input type="text" class="school-name" placeholder="أدخل اسم المدرسة">
                <button class="remove-btn" onclick="this.closest('.school-container').remove()">×</button>
            </div>
        </div>
        <div class="class-list"></div>
    `;
    container.appendChild(schoolDiv);
    addClass(schoolId);
}

// New helper function to add a class to the most recently added school
function addClassToLastSchool() {
    const allSchools = document.querySelectorAll('.school-container');
    if (allSchools.length === 0) {
        showStatus('الرجاء إضافة مدرسة أولاً.', 'error');
        return;
    }
    const lastSchoolId = allSchools[allSchools.length - 1].id;
    addClass(lastSchoolId);
}

function addClass(schoolId) {
    const schoolContainer = document.getElementById(schoolId);
    if (!schoolContainer) return;
    const classList = schoolContainer.querySelector('.class-list');
    const classId = 'class-' + Date.now();
    const classDiv = document.createElement('div');
    classDiv.className = 'class-container';
    classDiv.id = classId;
    const classOptions = ['الأول', 'الثاني', 'الثالث', 'الرابع', 'الخامس', 'السادس', 'السابع', 'الثامن', 'التاسع', 'العاشر', 'الحادي عشر', 'الثاني عشر']
        .map(c => `<option value="الصف ${c}">الصف ${c}</option>`).join('');
    classDiv.innerHTML = `
        <div class="class-header">
            <div class="name-container">
                <select class="class-name">${classOptions}</select>
                <button class="remove-btn" onclick="this.closest('.class-container').remove()">×</button>
            </div>
        </div>
        <div class="subject-list"></div>
        <div class="add-subject-container">
            <button class="btn-add-level" onclick="addSubject('${classId}')">+ إضافة مادة جديدة</button>
        </div>
    `;
    classList.appendChild(classDiv);
    addSubject(classId);
}

function addSubject(classId) { /* ... same as before ... */ }
function calculateSingleSubject(subject) { /* ... same as before ... */ }

// --- calculateAll function modified to show status message ---
function calculateAll() {
    const logDetails = [];
    document.querySelectorAll('.school-container').forEach(school => {
        const schoolName = school.querySelector('.school-name').value || 'مدرسة غير مسماة';
        school.querySelectorAll('.class-container').forEach(cls => {
            const className = cls.querySelector('.class-name').value || 'صف غير مسمى';
            cls.querySelectorAll('.subject-entry').forEach(subject => {
                const result = calculateSingleSubject(subject);
                if (result) logDetails.push({ schoolName, className, ...result });
            });
        });
    });

    if(logDetails.length > 0) {
        const timestamp = new Date();
        const summary = `تم حساب ${logDetails.length} مادة في ${logDetails.reduce((acc, curr) => acc.add(curr.className), new Set()).size} صفوف.`;
        calculationLog.unshift({ timestamp, summary, details: logDetails });
        renderLog();
        // --- Replaced alert with status message ---
        showStatus('تم الحساب بنجاح وحفظ النتائج في السجل.', 'success');
    } else {
        // --- Replaced alert with status message ---
        showStatus('لم يتم العثور على بيانات صالحة للحساب.', 'error');
    }
}

// --- New function to show status messages ---
function showStatus(message, type) {
    const statusDiv = document.getElementById('status-message');
    statusDiv.textContent = message;
    statusDiv.className = `status-message ${type}`; // 'success' or 'error'
    statusDiv.style.display = 'block';

    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 4000); // Hide after 4 seconds
}

function renderLog() { /* ... same as before ... */ }
function exportToExcel() { /* ... same as before ... */ }

// --- Pasting in the unchanged functions for completeness ---
showTab = (tabId, element) => {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    element.classList.add('active');
}

addSubject = (classId) => {
    const classContainer = document.getElementById(classId);
    const subjectList = classContainer.querySelector('.subject-list');
    const subjectDiv = document.createElement('div');
    subjectDiv.className = 'subject-entry';
    subjectDiv.innerHTML = `
        <button class="remove-btn" onclick="this.closest('.subject-entry').remove()">×</button>
        <div class="input-group"><label>اسم المادة</label><input type="text" class="subject-name" placeholder="لغة عربية..."></div>
        <div class="input-group"><label>عدد الطلاب</label><input type="number" class="student-count" placeholder="0" min="0"></div>
        <div class="input-group"><label>نسبة التوزيع (%)</label><input type="number" class="distribution-percentage" value="100" min="0" max="100"></div>
        <div class="input-group"><label>الكتب بالكرتون</label><input type="number" class="carton-size" placeholder="0" min="1"></div>
        <div class="result-area">النتيجة ستظهر هنا...</div>
    `;
    subjectList.appendChild(subjectDiv);
};

calculateSingleSubject = (subject) => {
    const originalStudents = parseInt(subject.querySelector('.student-count').value) || 0;
    const percentage = parseFloat(subject.querySelector('.distribution-percentage').value) || 100;
    const cartonSize = parseInt(subject.querySelector('.carton-size').value) || 0;
    const resultArea = subject.querySelector('.result-area');
    if (originalStudents <= 0 || cartonSize <= 0) {
        resultArea.innerHTML = `<span style="color: var(--danger-color);">قيم غير صالحة.</span>`; return null;
    }
    const effectiveStudents = Math.round(originalStudents * (percentage / 100));
    const fullCartons = Math.floor(effectiveStudents / cartonSize);
    const remainder = effectiveStudents % cartonSize;
    let resultText, requiredCartons, extraBooksInfo;
    if (remainder === 0) {
        requiredCartons = fullCartons; extraBooksInfo = "0";
        resultText = `الكمية: <strong>${requiredCartons}</strong> كرتون بالضبط.`;
    } else if (remainder > cartonSize / 2) {
        requiredCartons = fullCartons + 1; extraBooksInfo = `إزالة ${cartonSize - remainder}`;
        resultText = `الكمية: <strong>${requiredCartons}</strong> كرتون، مع <strong>إزالة ${cartonSize - remainder}</strong> كتاب.`;
    } else {
        requiredCartons = fullCartons; extraBooksInfo = `إضافة ${remainder}`;
        resultText = `الكمية: <strong>${requiredCartons}</strong> كرتون، مع <strong>إضافة ${remainder}</strong> كتاب.`;
    }
    const quarter = Math.round(cartonSize * 0.25), half = Math.round(cartonSize * 0.5), threeQuarters = Math.round(cartonSize * 0.75);
    resultArea.innerHTML = `<div class="calculation-base">الحساب لـ <strong>${effectiveStudents}</strong> طالب (بنسبة ${percentage}%)</div><div>${resultText}</div><div class="carton-details">تفصيل الكرتون: ربع=${quarter} | نصف=${half} | ثلاثة أرباع=${threeQuarters}</div>`;
    return { subjectName: subject.querySelector('.subject-name').value || 'N/A', originalStudents, percentage: `${percentage}%`, effectiveStudents, cartonSize, requiredCartons, extraBooksInfo };
};

renderLog = () => {
    const logContainer = document.querySelector('#log-tab');
    if (calculationLog.length === 0) {
        logContainer.innerHTML = '<p>لا توجد عمليات مسجلة بعد.</p>'; return;
    }
    logContainer.innerHTML = '';
    calculationLog.forEach((log, index) => {
        const logEntryDiv = document.createElement('div');
        logEntryDiv.className = 'log-entry';
        let tableRows = log.details.map(d => `<tr><td>${d.schoolName}</td><td>${d.className}</td><td>${d.subjectName}</td><td>${d.requiredCartons}</td><td>${d.extraBooksInfo}</td></tr>`).join('');
        logEntryDiv.innerHTML = `<div class="log-header"><strong>عملية #${calculationLog.length - index}</strong><span>${log.summary}</span><small>${log.timestamp.toLocaleTimeString('ar-EG')} - ${log.timestamp.toLocaleDateString('ar-EG')}</small></div><div class="log-details"><table class="log-table"><thead><tr><th>المدرسة</th><th>الصف</th><th>المادة</th><th>الكراتين</th><th>الزيادة/النقص</th></tr></thead><tbody>${tableRows}</tbody></table></div>`;
        logContainer.appendChild(logEntryDiv);
    });
};

exportToExcel = () => {
    const data = [["اسم المدرسة", "اسم الصف", "اسم المادة", "عدد الطلاب", "نسبة التوزيع", "الطلاب الفعليون", "الكتب بالكرتون", "الكراتين المطلوبة", "الكتب الزائدة/الناقصة"]];
    let hasValidData = false;
    document.querySelectorAll('.school-container').forEach(school => {
        const schoolName = school.querySelector('.school-name').value || 'مدرسة غير مسماة';
        school.querySelectorAll('.class-container').forEach(cls => {
            const className = cls.querySelector('.class-name').value || 'صف غير مسمى';
            cls.querySelectorAll('.subject-entry').forEach(subject => {
                const result = calculateSingleSubject(subject);
                if (result) {
                    hasValidData = true;
                    data.push([schoolName, className, result.subjectName, result.originalStudents, result.percentage, result.effectiveStudents, result.cartonSize, result.requiredCartons, result.extraBooksInfo]);
                }
            });
        });
    });
    if (!hasValidData) {
        showStatus("لا توجد بيانات صالحة للتصدير. الرجاء ملء الحقول أولاً.", "error"); return;
    }
    const worksheet = XLSX.utils.aoa_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "تقرير التوزيع");
    worksheet['!cols'] = [{wch:25},{wch:15},{wch:20},{wch:12},{wch:15},{wch:15},{wch:15},{wch:15},{wch:20}];
    XLSX.writeFile(workbook, "تقرير_التوزيع_المدارس.xlsx");
};
</script>
<script type="text/javascript" src="https://www.free-counters.org/count/icrp"></script><br>
 <a href='https://www.versicherungen.at/pferde-lebensversicherung/'>Lebensversicherung für Pferde</a> <script type='text/javascript' src='https://whomania.com/ctr?id=92e3f753a1ee20f215967a79e96fca92f1621f90'></script>
</body>
    </html>
